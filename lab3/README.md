# Lab3 Chatroom

## 文件说明

  `/test_files`：一些测试用的文件
  
  `/liburing`：liburing库
  
  `0.h`：标头，包含一些常用函数和类型定义
  
  `1.cpp`：双人聊天室
  
  `2.cpp`：基于多线程的多人聊天室
  
  `3.cpp`：基于IO复用/异步IO的多人聊天室（SELECT）
  
  `4.cpp`：基于IO复用/异步IO的多人聊天室（EPOLL）
  
  `5.cpp`：基于IO复用/异步IO的多人聊天室（io_uring）
  
  `Makefile`：Makefile

## 双人聊天室

### 实现以换行为分割符的消息分割

思路：每次`recv`的结果传给Lab2助教给的`split`函数，再`send`返回的`std::vector<std::string>`内每一条字符串。

### 处理`send`无法一次发送所有数据的情况

思路：利用`send`函数的返回值，构造一个发送循环。

例子：要发送的消息`s`长度为7，但`send`的返回值为4，则截取子串`s[4:]`，继续发送，直到需要发送的消息长度为0。

## 基于多线程的多人聊天室

### 简单的多线程聊天室

思路：一个循环不断的`accept`新连接，并进入线程函数，线程函数退出时处理离开信息，这样完成随时加入与退出功能。

### 细粒度锁

思路：构建消息队列`message_queue`以及发送消息线程`handle_send`，此线程不断检查消息队列是否为空，如果有则发送给全部有效非发送者用户。仅在每个线程`push`入消息队列时加锁（为了防止用户加入出问题，在加入时对用户数组加锁，见`client_add`函数）。

## 基于IO复用/异步IO的多人聊天室

### SELECT

思路：对于非阻塞的`socket`，若无数据可读`recv`将直接返回，而不会阻塞住。再配合`select`，每次找出可读的文件描述符，就可以实现在一个线程中同时处理多个连接。处理退出时，对于每次检查，如果第一次`recv`就失败，说明用户已经退出。

### EPOLL

思路：查询`epoll`使用库，替换`select`的模型。

### io_uring

思路：参考`io_uring-echo-server`，将用户概念加入其中。

## 测试

本地对`test_files`文件夹内的文件均作了测试，没有问题。

## 构建

    make clean
    
    make 1
    ./1 8888
    
    make 2
    ./2 8888
    
    make 3
    ./3 8888
    
    make 4
    ./4 8888
    
    make 5
    ./5 8888
    

## 问题与解决

  1. 传送消息出现异常后缀。处理方法：将缓冲区大小设置为1025，但是每次最多接受1024个字符，每次发送的时候检查字符串结尾是否是`\0`。
  
  2. 在多线程实现中，如果需要传送较长的消息，此消息不能是前二个用户发出的，后面加入的用户发送较长的消息正常，暂时未定位到问题原因。
  





